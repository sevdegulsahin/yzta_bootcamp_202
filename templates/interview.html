{% extends "base.html" %}

{% block title %}Mülakat Simülasyonu - Interviewly{% endblock %}

<!-- ================================================================= -->
<!-- ÇÖZÜM 1: 'BİTİR' BUTONUNUN ÇALIŞMASI İÇİN EKSİK CSS EKLENDİ -->
<!-- ================================================================= -->
{% block styles %}
<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal.show {
        display: flex;
    }
    .modal-content {
        background: white;
        border: 1px solid #ccc;
        border-radius: 1rem;
        max-width: 400px;
        width: 90%;
        animation: modalSlide 0.3s ease-out;
    }
    @keyframes modalSlide {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #eee; }
    .modal-header h3 { display: flex; align-items: center; gap: 0.5rem; margin: 0; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-header h3 { 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
        margin: 0; 
        color: #000000; /* Başlık rengi siyah yapıldı */
    }
    .modal-body { 
        padding: 1.5rem; 
        color: #000000; /* İçerik metni rengi siyah yapıldı */
    }
</style>
{% endblock %}


{% block content %}
<!-- SÜRE BİLGİSİNİ TUTMAK İÇİN DATA ATTRIBUTE EKLENDİ -->
<div class="interview-page" data-duration="{{ duration }}">
    <div class="interview-container">
        <!-- Interview Header -->
        <div class="interview-header" data-aos="fade-down">
            <div class="header-content">
                <div class="interview-info">
                    <h1 class="interview-title">
                        <i class="fas fa-comments"></i>
                        Mülakat Simülasyonu
                    </h1>
                    <p class="interview-subtitle">AI Asistan ile gerçek zamanlı mülakat deneyimi</p>
                </div>
                <div class="interview-controls">
                    <div class="timer" id="timer">
                        <i class="fas fa-clock"></i>
                        <!-- Başlangıç değeri JS ile ayarlanacak -->
                        <span id="timer-display">--:--</span>
                    </div>
                    <button class="btn btn-secondary" onclick="resetInterview()">
                        <i class="fas fa-redo"></i>
                        Yeniden Başlat
                    </button>
                    <button class="btn btn-danger" onclick="endInterview()">
                        <i class="fas fa-stop"></i>
                        Bitir
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Interface (Bu bölümün HTML'i orijinaliyle aynı, değişiklik yok) -->
        <div class="chat-interface" data-aos="fade-up">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    {% for message in chat_history %}
                    {% if message.role != 'system' %}
                    <div class="message-wrapper {{ message.role }}">
                        <div class="message {{ message.role }}">
                            <div class="message-avatar">
                                {% if message.role == 'assistant' %}
                                <i class="fas fa-robot"></i>
                                {% else %}
                                <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">
                                        {% if message.role == 'assistant' %}
                                        AI Mülakatçı
                                        {% else %}
                                        Siz
                                        {% endif %}
                                    </span>
                                    <span class="message-time">{{ loop.index }}</span>
                                </div>
                                <div class="message-text">
                                    {{ message.content }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="message assistant"><div class="message-avatar"><i class="fas fa-robot"></i></div><div class="message-content"><div class="message-header"><span class="message-sender">AI Mülakatçı</span></div><div class="typing-dots"><span></span><span></span><span></span></div></div></div>
                </div>
            </div>
            <div class="chat-input-container">
                <form method="POST" class="chat-form" id="chat-form">
                    <div class="input-wrapper"><textarea name="user_input" id="user-input" class="chat-input" placeholder="Cevabınızı yazın..." rows="1" required maxlength="1000"></textarea><div class="input-actions"><div class="char-counter" id="char-counter">0/1000</div><button type="submit" class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button></div></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- End Interview Modal (HTML'i orijinaliyle aynı, değişiklik yok) -->
<div class="modal" id="endModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Mülakatı Bitir</h3>
        </div>
        <div class="modal-body">
            <p>Mülakatı bitirmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">İptal</button>
            <button class="btn btn-danger" onclick="confirmEndInterview()">Evet, Bitir</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- BU BÖLÜM ORİJİNAL YAPINIZA SADIK KALINARAK GÜNCELLENDİ ---

    let timerInterval; // Bu değişken globalde kalabilir

    // Orijinal fonksiyonlarınız (hiçbir değişiklik yok)
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    function updateCharCounter() {
        const input = document.getElementById('user-input');
        const counter = document.getElementById('char-counter');
        const count = input.value.length;
        counter.textContent = `${count}/1000`;
        if (count > 900) { counter.style.color = '#ef4444'; } 
        else if (count > 800) { counter.style.color = '#f59e0b'; } 
        else { counter.style.color = 'var(--text-muted)'; }
    }
    function scrollToBottom() {
        const chatContainer = document.querySelector('.chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function showTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'flex';
        scrollToBottom();
    }
    function hideTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'none';
    }
    function addMessage(content, role) {
        const chatMessages = document.getElementById('chat-messages');
        const messageCount = chatMessages.querySelectorAll('.message-wrapper').length + 1;
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper ${role}`;
        const avatar = role === 'assistant' ? 'fa-robot' : 'fa-user';
        const sender = role === 'assistant' ? 'AI Mülakatçı' : 'Siz';
        messageWrapper.innerHTML = `<div class="message ${role}"><div class="message-avatar"><i class="fas ${avatar}"></i></div><div class="message-content"><div class="message-header"><span class="message-sender">${sender}</span><span class="message-time">${messageCount}</span></div><div class="message-text">${content}</div></div></div>`;
        chatMessages.appendChild(messageWrapper);
        scrollToBottom();
    }
    document.getElementById('chat-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        input.value = '';
        autoResize(input);
        updateCharCounter();
        showTypingIndicator();
        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;
        fetch("{{ url_for('interview.interview') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_input: message })})
        .then(response => response.json())
        .then(data => { hideTypingIndicator(); addMessage(data.ai_reply, 'assistant'); sendBtn.disabled = false; input.focus(); })
        .catch(error => { console.error('Hata:', error); hideTypingIndicator(); addMessage("Bir hata oluştu, lütfen tekrar deneyin.", 'assistant'); sendBtn.disabled = false; });
    });
    function endInterview() { document.getElementById('endModal').classList.add('show'); }
    function closeModal() { document.getElementById('endModal').classList.remove('show'); }
    function confirmEndInterview() { window.location.href = "{{ url_for('interview.assistant_results') }}"; }
    function resetInterview() { if (confirm('Mülakatı yeniden başlatmak istediğinizden emin misiniz?')) { window.location.href = "{{ url_for('interview.reset_interview') }}"; } }

    // Initialize (Sayfa yüklendiğinde çalışan ana mantık)
    document.addEventListener('DOMContentLoaded', function () {
        
        // ÇÖZÜM 2: ZAMANLAYICI MANTIĞI BURADA GÜNCELLENDİ
        const interviewPage = document.querySelector('.interview-page');
        const timerDisplay = document.getElementById('timer-display');
        const durationInSeconds = parseInt(interviewPage.dataset.duration, 10);

        function startCountdown(seconds) {
            let remainingTime = seconds;
            // Mevcut global timerInterval değişkenini kullanıyoruz
            timerInterval = setInterval(() => {
                if (remainingTime < 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Süre Doldu!";
                    document.getElementById('user-input').disabled = true;
                    document.getElementById('send-btn').disabled = true;
                    alert("Mülakat süreniz dolmuştur. Sonuç sayfasına yönlendiriliyorsunuz.");
                    confirmEndInterview();
                    return;
                }
                const minutes = Math.floor(remainingTime / 60);
                const secs = remainingTime % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                remainingTime--;
            }, 1000);
        }

        // Eski startTimer() çağrısı yerine yeni mantığı koyuyoruz
        if (durationInSeconds && !isNaN(durationInSeconds)) {
            startCountdown(durationInSeconds);
        } else {
            timerDisplay.textContent = "Hata!";
            console.error("Mülakat süresi alınamadı.");
        }

        // Orijinal kodunuzdaki diğer başlangıç ayarları (hiçbir değişiklik yok)
        const textarea = document.getElementById('user-input');
        textarea.addEventListener('input', function() {
            autoResize(this);
            updateCharCounter();
        });
        updateCharCounter();
        scrollToBottom();
        textarea.focus();
    });

    // Orijinal kodunuzdaki event listener (hiçbir değişiklik yok)
    document.getElementById('endModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}