{% extends "base.html" %}

{% block title %}{{ category | capitalize }} Mülakat Sorusu #{{ question_num }} - Interviewly{% endblock %}

{% block content %}
<div class="question-page">
    <div class="container">
        <!-- Progress Header -->
        <div class="progress-header" data-aos="fade-down">
            <div class="progress-info">
                <h1 class="page-title">
                    <i class="fas fa-question-circle"></i>
                    {{ category | capitalize }} Mülakatı
                </h1>
                <div class="progress-details">
                    <span class="progress-text">Soru {{ question_num }} / {{ total_questions }}</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (question_num / total_questions) * 100 }}%"></div>
                    </div>
                </div>
            </div>
            <div class="question-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="timer">00:00</span>
                        <span class="stat-label">Geçen Süre</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">{{ ((question_num - 1) / total_questions * 100) | round(1) }}%</span>
                        <span class="stat-label">Tamamlanan</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card" data-aos="fade-up">
            <div class="question-header">
                <div class="question-meta">
                    <span class="question-number">Soru #{{ question_num }}</span>
                    <span class="question-category">{{ category | capitalize }}</span>
                </div>
                <div class="question-actions">
                    <button class="action-btn" onclick="toggleFullscreen()" title="Tam ekran">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="action-btn" onclick="copyQuestion()" title="Soruyu kopyala">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <div class="question-content">
                <div class="question-text">
                    {{ question_text | safe }}
                </div>
            </div>

            <!-- Answer Form -->
            <div class="answer-section">
                <form method="POST" action="{{ url_for('interview.interview') }}" class="answer-form" id="answerForm">
                    <div class="form-group">
                        <label for="user_input" class="form-label">
                            <i class="fas fa-edit"></i>
                            Cevabınızı yazın
                        </label>
                        <div class="textarea-wrapper">
                            <textarea id="user_input" name="user_input" class="answer-textarea"
                                placeholder="Cevabınızı buraya yazın..." required rows="6" maxlength="2000"></textarea>
                            <div class="textarea-footer">
                                <div class="char-counter" id="charCounter">0/2000</div>
                                <div class="word-counter" id="wordCounter">0 kelime</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                            <i class="fas fa-save"></i>
                            Taslak Kaydet
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            Cevabı Gönder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation-section" data-aos="fade-up" data-aos-delay="200">
            <div class="nav-buttons">
                {% if question_num > 1 %}
                <a href="{{ url_for('interview.interview_question_route', category=category, question_num=question_num - 1) }}"
                    class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Önceki Soru
                </a>
                {% endif %}

                <div class="nav-center">
                    <a href="{{ url_for('interview.interview') }}" class="btn btn-secondary">
                        <i class="fas fa-comments"></i>
                        Sohbet Odasına Dön
                    </a>
                </div>

                {% if question_num < total_questions %} <a
                    href="{{ url_for('interview.interview_question_route', category=category, question_num=question_num + 1) }}"
                    class="btn btn-outline">
                    Sonraki Soru
                    <i class="fas fa-arrow-right"></i>
                    </a>
                    {% else %}
                    <a href="{{ url_for('interview.interview') }}" class="btn btn-success">
                        <i class="fas fa-check-circle"></i>
                        Mülakatı Tamamla
                    </a>
                    {% endif %}
            </div>

            <div class="quick-actions">
                <a href="{{ url_for('interview.create_interview') }}" class="quick-action-btn">
                    <i class="fas fa-plus"></i>
                    Yeni Mülakat
                </a>
                <a href="{{ url_for('interview.my_interviews') }}" class="quick-action-btn">
                    <i class="fas fa-history"></i>
                    Geçmiş Mülakatlar
                </a>
                <a href="{{ url_for('main.index') }}" class="quick-action-btn">
                    <i class="fas fa-home"></i>
                    Ana Sayfa
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Save Draft Modal -->
<div class="modal" id="saveModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-save"></i> Taslak Kaydet</h3>
        </div>
        <div class="modal-body">
            <p>Cevabınızı taslak olarak kaydetmek istediğinizden emin misiniz?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">İptal</button>
            <button class="btn btn-primary" onclick="confirmSaveDraft()">Kaydet</button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    let startTime = Date.now();
    let timerInterval;
    // Initialize timer
    function startTimer() {
        timerInterval = setInterval(updateTimer, 1000);
    }
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('timer').textContent = display;
    }
    // Character and word counter
    function updateCounters() {
        const textarea = document.getElementById('user_input');
        const text = textarea.value;
        const charCount = text.length;
        const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        document.getElementById('charCounter').textContent = `${charCount}/2000`;
        document.getElementById('wordCounter').textContent = `${wordCount} kelime`;
        const charCounter = document.getElementById('charCounter');
        if (charCount > 1800) {
            charCounter.style.color = '#ef4444';
        } else if (charCount > 1600) {
            charCounter.style.color = '#f59e0b';
        } else {
            charCounter.style.color = 'var(--text-muted)';
        }
    }
    // Auto-resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
    }
    // Copy question text
    function copyQuestion() {
        const questionText = document.querySelector('.question-text').textContent;
        navigator.clipboard.writeText(questionText).then(() => {
            console.log('Soru kopyalandı!');
        }).catch(err => {
            console.error('Kopyalama hatası:', err);
        });
    }
    // Toggle fullscreen
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
    // Save draft functionality
    function saveDraft() {
        const textarea = document.getElementById('user_input');
        if (textarea.value.trim()) {
            document.getElementById('saveModal').classList.add('show');
        } else {
            console.warn('Kaydedilecek cevap bulunamadı');
        }
    }
    function closeModal() {
        document.getElementById('saveModal').classList.remove('show');
    }
    function confirmSaveDraft() {
        const textarea = document.getElementById('user_input');
        const draft = {
            question: String({{ question_num }}),
            answer: textarea.value,
            timestamp: new Date().toISOString()
    };
    localStorage.setItem('interview_draft', JSON.stringify(draft));
    console.log('Taslak kaydedildi!');
    closeModal();
}
    // Load draft on page load
    function loadDraft() {
        const draft = localStorage.getItem('interview_draft');
        if (draft) {
            const draftData = JSON.parse(draft);
            if (String(draftData.question) === String({{ question_num }})) {
            const textarea = document.getElementById('user_input');
            textarea.value = draftData.answer;
            updateCounters();
            autoResize(textarea);
        }
    }
}
    document.addEventListener('DOMContentLoaded', function () {
        // Start timer
        startTimer();
        // Setup textarea events
        const textarea = document.getElementById('user_input');
        textarea.addEventListener('input', function () {
            updateCounters();
            autoResize(this);
        });
        // Load draft
        loadDraft();
        // Focus on textarea
        textarea.focus();
        // Close modal when clicking outside
        document.getElementById('saveModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });
        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submitBtn').click();
            }
            // Ctrl/Cmd + S to save draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
            // ESC ile modal kapat
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // Form submit event
        document.getElementById('answerForm').addEventListener('submit', function (e) {
            const textarea = document.getElementById('user_input');
            const submitBtn = document.getElementById('submitBtn');
            if (!textarea.value.trim()) {
                e.preventDefault();
                console.warn('Lütfen bir cevap yazın');
                return;
            }
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';
            // Clear draft
            localStorage.removeItem('interview_draft');
        });
    });
</script>
{% endblock %}